syntax = "proto3";

package pipeline.v1;

import "pipeline/v1/pipeline_spec.proto";
import "pipeline/v1/pipeline_error.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/arcentrix/arcentra/api/pipeline/v1;pipelinev1";

// PipelineService - Pipeline management interface.
service PipelineService {
  // Create pipeline metadata (definition is stored in repository file).
  rpc CreatePipeline(CreatePipelineRequest) returns (CreatePipelineResponse) {}

  // Update pipeline metadata.
  rpc UpdatePipeline(UpdatePipelineRequest) returns (UpdatePipelineResponse) {}

  // Get pipeline detail.
  rpc GetPipeline(GetPipelineRequest) returns (GetPipelineResponse) {}

  // List pipelines.
  rpc ListPipelines(ListPipelinesRequest) returns (ListPipelinesResponse) {}

  // Delete pipeline.
  rpc DeletePipeline(DeletePipelineRequest) returns (DeletePipelineResponse) {}

  // Trigger pipeline execution.
  rpc TriggerPipeline(TriggerPipelineRequest) returns (TriggerPipelineResponse) {}

  // Stop pipeline execution.
  rpc StopPipeline(StopPipelineRequest) returns (StopPipelineResponse) {}

  // Pause pipeline execution.
  rpc PausePipeline(PausePipelineRequest) returns (PausePipelineResponse) {}

  // Resume pipeline execution.
  rpc ResumePipeline(ResumePipelineRequest) returns (ResumePipelineResponse) {}

  // Get pipeline run detail.
  rpc GetPipelineRun(GetPipelineRunRequest) returns (GetPipelineRunResponse) {}

  // List pipeline runs.
  rpc ListPipelineRuns(ListPipelineRunsRequest) returns (ListPipelineRunsResponse) {}

  // Read pipeline spec from repository.
  rpc GetPipelineSpec(GetPipelineSpecRequest) returns (GetPipelineSpecResponse) {}

  // Validate pipeline spec content without persisting.
  rpc ValidatePipelineSpec(ValidatePipelineSpecRequest) returns (ValidatePipelineSpecResponse) {}

  // Save pipeline spec and push to repository.
  rpc SavePipelineSpec(SavePipelineSpecRequest) returns (SavePipelineSpecResponse) {}
}

enum PipelineStatus {
  PIPELINE_STATUS_UNSPECIFIED = 0;
  PIPELINE_STATUS_PENDING = 1;
  PIPELINE_STATUS_RUNNING = 2;
  PIPELINE_STATUS_SUCCESS = 3;
  PIPELINE_STATUS_FAILED = 4;
  PIPELINE_STATUS_CANCELLED = 5;
  PIPELINE_STATUS_PAUSED = 6;
}

enum TriggerType {
  TRIGGER_TYPE_UNSPECIFIED = 0;
  TRIGGER_TYPE_MANUAL = 1;
  TRIGGER_TYPE_CRON = 2;
  TRIGGER_TYPE_EVENT = 3;
}

enum PipelineSaveMode {
  PIPELINE_SAVE_MODE_UNSPECIFIED = 0;
  PIPELINE_SAVE_MODE_DIRECT = 1;
  PIPELINE_SAVE_MODE_PR = 2;
}

enum SpecFormat {
  SPEC_FORMAT_UNSPECIFIED = 0;
  SPEC_FORMAT_JSON = 1;
  SPEC_FORMAT_YAML = 2;
}

message CreatePipelineRequest {
  string project_id = 1;
  string name = 2;
  string description = 3;
  string repo_url = 4;
  string default_branch = 5;
  string pipeline_file_path = 6;
  PipelineSaveMode save_mode = 7;
  string pr_target_branch = 8;
  map<string, string> metadata = 9;
  string created_by = 10;
}

message UpdatePipelineRequest {
  string pipeline_id = 1;
  string name = 2;
  string description = 3;
  string repo_url = 4;
  string default_branch = 5;
  string pipeline_file_path = 6;
  PipelineSaveMode save_mode = 7;
  string pr_target_branch = 8;
  map<string, string> metadata = 9;
  int32 is_enabled = 10;
}

message GetPipelineRequest {
  string pipeline_id = 1;
}

message ListPipelinesRequest {
  string project_id = 1;
  PipelineStatus status = 2;
  int32 page = 3;
  int32 page_size = 4;
  string name = 5;
}

message DeletePipelineRequest {
  string pipeline_id = 1;
}

message PipelineDetail {
  string pipeline_id = 1;
  string project_id = 2;
  string name = 3;
  string description = 4;
  string repo_url = 5;
  string default_branch = 6;
  string pipeline_file_path = 7;
  PipelineStatus status = 8;
  PipelineSaveMode save_mode = 9;
  string pr_target_branch = 10;
  map<string, string> metadata = 11;
  string last_sync_message = 12;
  int64 last_synced_at = 13;
  string last_editor = 14;
  string last_commit_sha = 15;
  int32 total_runs = 16;
  int32 success_runs = 17;
  int32 failed_runs = 18;
  string created_by = 19;
  int32 is_enabled = 20;
  int64 created_at = 21;
  int64 updated_at = 22;
}

message CreatePipelineResponse {
  bool success = 1;
  string message = 2;
  string pipeline_id = 3;
  Error error = 4;
}

message UpdatePipelineResponse {
  bool success = 1;
  string message = 2;
  Error error = 3;
}

message GetPipelineResponse {
  bool success = 1;
  string message = 2;
  PipelineDetail pipeline = 3;
  Error error = 4;
}

message ListPipelinesResponse {
  bool success = 1;
  string message = 2;
  repeated PipelineDetail pipelines = 3;
  int32 total = 4;
  int32 page = 5;
  int32 page_size = 6;
}

message DeletePipelineResponse {
  bool success = 1;
  string message = 2;
  Error error = 3;
}

message TriggerPipelineRequest {
  string pipeline_id = 1;
  map<string, string> variables = 2;
  string triggered_by = 3;
  // Idempotency key in pipeline scope (pipeline_id + request_id).
  string request_id = 4;
}

message TriggerPipelineResponse {
  bool success = 1;
  string message = 2;
  string run_id = 3;
  Error error = 4;
}

message StopPipelineRequest {
  string pipeline_id = 1;
  string run_id = 2;
  string reason = 3;
}

message StopPipelineResponse {
  bool success = 1;
  string message = 2;
  Error error = 3;
}

message PausePipelineRequest {
  string pipeline_id = 1;
  string run_id = 2;
  string reason = 3;
  string operator = 4;
}

message PausePipelineResponse {
  bool success = 1;
  string message = 2;
  Error error = 3;
}

message ResumePipelineRequest {
  string pipeline_id = 1;
  string run_id = 2;
  string reason = 3;
  string operator = 4;
}

message ResumePipelineResponse {
  bool success = 1;
  string message = 2;
  Error error = 3;
}

message GetPipelineRunRequest {
  string run_id = 1;
}

message ListPipelineRunsRequest {
  string pipeline_id = 1;
  PipelineStatus status = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message PipelineRunDetail {
  string run_id = 1;
  string pipeline_id = 2;
  string pipeline_name = 3;
  string branch = 4;
  string commit_sha = 5;
  string definition_commit_sha = 6;
  string definition_path = 7;
  PipelineStatus status = 8;
  TriggerType trigger_type = 9;
  string triggered_by = 10;
  map<string, string> variables = 11;
  int32 total_jobs = 12;
  int32 completed_jobs = 13;
  int32 failed_jobs = 14;
  int32 running_jobs = 15;
  int64 start_time = 16;
  int64 end_time = 17;
  int64 duration = 18;
}

message GetPipelineRunResponse {
  bool success = 1;
  string message = 2;
  PipelineRunDetail run = 3;
  Error error = 4;
}

message ListPipelineRunsResponse {
  bool success = 1;
  string message = 2;
  repeated PipelineRunDetail runs = 3;
  int32 total = 4;
  int32 page = 5;
  int32 page_size = 6;
}

message GetPipelineSpecRequest {
  string pipeline_id = 1;
}

message GetPipelineSpecResponse {
  bool success = 1;
  string message = 2;
  Spec spec = 3;
  SpecFormat format = 4;
  string head_commit_sha = 5;
  string branch = 6;
  string pipeline_file_path = 7;
  Error error = 8;
}

message ValidatePipelineSpecRequest {
  string pipeline_id = 1;
  Spec spec = 2;
  SpecFormat format = 3;
}

message ValidatePipelineSpecResponse {
  bool success = 1;
  string message = 2;
  int32 jobs_count = 3;
  repeated string warnings = 4;
  Error error = 5;
}

message SavePipelineSpecRequest {
  string pipeline_id = 1;
  Spec spec = 2;
  SpecFormat format = 3;
  string expected_head_commit_sha = 4;
  string commit_message = 5;
  string request_id = 6;
  string editor = 7;
}

message SavePipelineSpecResponse {
  bool success = 1;
  string message = 2;
  string commit_sha = 3;
  string branch = 4;
  PipelineSaveMode save_mode = 5;
  string pr_url = 6;
  string pr_branch = 7;
  Error error = 8;
}

